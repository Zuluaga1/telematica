<!doctype html>
<html lang="en">
<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
    integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
  <link rel="stylesheet" href="assets/css/main.css">
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@200;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/ionicons@5.2.3/dist/ionicons.js"></script>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
  <script src='/socket.io/socket.io.js'></script>
  <title>COVID-19 Manager</title>
  <script>
    var socket = io.connect('http://localhost:80');
  </script>
  <script type="text/javascript">
    var query = "SELECT  rc.examen, COUNT(rc.examen) AS Total FROM registro_caso rc GROUP by rc.examen";
    socket.emit('post',query);

    var query2 = `SELECT  e.estado, COUNT(e.idcaso) FROM estado e
                  INNER JOIN (SELECT idcaso, MAX(fecha) AS reciente FROM estado GROUP BY idcaso) aux 
                  ON e.idcaso = aux.idcaso
                  AND e.fecha = aux.reciente
                  WHERE e.estado != 1 AND e.estado != 5
                  GROUP BY e.estado
                  ORDER BY e.estado`;
    socket.emit('post2',query2);

    var query3 = `SELECT e.estado, COUNT(e.idcaso) AS Total FROM estado e
                  INNER JOIN (SELECT idcaso, MAX(fecha) AS reciente FROM estado GROUP BY idcaso) aux 
                  ON e.idcaso = aux.idcaso
                  AND e.fecha = aux.reciente
                  WHERE e.estado != 1
                  GROUP BY e.estado
                  ORDER BY e.estado`;
    socket.emit('post3',query3);

    var query4= "SELECT rc.fecha_examen, COUNT(rc.examen) AS CCR, 0 AS CM FROM registro_caso rc WHERE rc.examen='positivo' GROUP by rc.fecha_examen UNION ALL SELECT e.fecha, 0, COUNT(e.estado) FROM estado e WHERE e.estado=6 GROUP by e.fecha ORDER BY fecha_examen";
    socket.emit('post4',query4);
  </script>
</head>

<body>
  <nav class="navbar navbar-expand-lg bg-primary fixed-top">
    <div class="container">
      <a class="navbar-brand font-weight-bold" href="/landing.html">COVID-19 Manager</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item mx-4">
            <a class="nav-link" href="#hero">Inicio <span class="sr-only">(current)</span></a>
          </li>
          <li class="nav-item mx-4">
            <a class="nav-link" href="#stat">Estadísticas</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <section id="hero" class="section-index bg-primary">
    <div class="container mt-4">
      <div class="row">
        <div class="col-lg-6 col-sm-7 d-flex mt-3">
          <div class="align-self-center">
          <h1 class="text-light display-4">Bienvenido a COVID-19 Manager</h1>
          <p class="text-light lead mt-4">Este gestor está desarrollado para registrar los resultados de las pruebas
            realizadas del COVID-19 para la ciudad de Barranquilla.</p>
          <a href="login.html" class="btn btn-secondary mt-5">Inciar sesión <ion-icon name="arrow-forward-outline" class="ml-2 align-middle"></ion-icon></a>
          </div>
        </div>
        <div class="col-lg-5 offset-lg-1 col-sm-7 d-flex mt-3">
          <div class="align-self-center">
            <img src="assets/img/med.jpg" class="image-fluid main-photo">
          </div>
        </div>
      </div>
    </div>
  </section>

  <section id="stat" class="section-index bg-grey">
    <div class="container">
      <div class="heading-title">
        <h2>Estadísticas</h2>
        <p class="lead mt-3 mb-5">A continuación, se presenta la actualización de los resultados obtenidos mediante las pruebas del
           COVID-19 en la ciudad de Barranquilla
        </p>
      </div>
      <div class="row">
        <div class="col-md-4">
          <div class="card">
            <div class="card-body">
              <h4 class="mb-4 ">Casos positivos y negativos</h4>
              <canvas id="myChart1" style="width: 300px; height: 200px;"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-body">
              <h4 class="mb-4">Gráfica de infectados</h4>
              <canvas id="myChart2" style="width: 300px; height: 200px;"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-body">
              <h4 class="mb-4">Gráfica casos totales</h4>
              <canvas id="myChart3" style="width: 300px; height: 200px;"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-4">
        <div class="col-md-12">
          <div class="card">
            <div class="card-body">
              <h4 class="mb-4">Gráfica casos registrados por día</h4>
              <canvas id="myChart4" style="width: 500px; height: 200px;"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section id="footer" class="section-index bg-primary text-center">
    <div class="container">
      <h5 class="navbar-brand font-weight-bold text-light mx-1 mb-3">COVID-19 Manager</h5>
      <ul class="list-inline text-light">
        <li class="list-inline-item footer-menu"><a href="#hero">Inicio</a></li>
        <li class="list-inline-item footer-menu"><a href="#stat">Estadísticas</a></li>
      </ul>
      <small class="text-light">©2020 Todos los derechos reservados. 
        Creado por Juan Márquez, Sebastian Carrillo, Esteban Zuluaga y Jesus Yepez</small>
    </div>
  </section>

  <!-- Option 2: jQuery, Popper.js, and Bootstrap JS-->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/gh/cferdinandi/smooth-scroll/dist/smooth-scroll.polyfills.min.js"></script>

    <script>
      var ctx1 = document.getElementById('myChart1');
      var ctx2 = document.getElementById('myChart2');
      var ctx3 = document.getElementById('myChart3');
      var ctx4 = document.getElementById('myChart4');

      socket.on('show', function(message) {
        var myPieChart = new Chart(ctx1, {
        type: 'pie',
        data: {
          labels: ["Casos positivos", "Casos negativos"],
          datasets: [{
            data: [message[0], message[1]],
            backgroundColor: ["#ff0000", "#008f39"]
          }]
        },
        options: {
          responsive: true
        }
      });
      });

      socket.on('show2', function(message) {
        var myPieChart2 = new Chart(ctx2, {
        type: 'pie',
        data: {
          labels: ["Tratamiento Casa", "Tratamiento Hospital", "UCI", "Muerto"],
          datasets: [{
            data: [message[0], message[1], message[2], message[3]],
            backgroundColor: ["#FFB600", "#FF6400", "#003EFF", "#000000"]
          }]
        },
        options: {
          responsive: true
        }
        });
      });

      socket.on('show3', function(message) {
        var myPieChart3 = new Chart(ctx3, {
        type: 'pie',
        data: {
          labels: ["Infectados", "Curados", "Muertos"],
          datasets: [{
            data: [message[0]+message[1]+message[2], message[3], message[4]],
            backgroundColor: ["#ff0000", "#000000", "#008f39"]
          }]
        },
        options: {
          responsive: false
        }
      });
      });

    socket.on('show4', function(msg) {
      var message = msg[0];
      var message1 = msg[1];
      var message2 = msg[2];

      for (let i = 0; i < message.length; i++) {
        var lqws = message[i];
        if (lqws== message[i+1]){
            message1.splice(i+1,1)
            message2.splice(i,1)
            message.splice(i,1)
          }
      }

      var myBarChart = new Chart(ctx4, {
        type: 'line',
        data: {
          labels: message,
          datasets: [{
          label: "Registrados",
          fill: false,
          data: message1,
          borderColor: "#ff0000"
        },
        {
          label: "Muertos",
          fill: false,
          data: message2,
          borderColor: "#000000"
        }]    
        },
        options: {
            responsive:true,
          scales: {
          yAxes:[{
            scaleStepWidth:1
          }],
          xAxes: [{
              gridLines: {
                  offsetGridLines: true
              }
          }]
          }
          
        }
      });
    });
  </script>
  <script>
    var scroll = new SmoothScroll('a[href*="#"]');
  </script>
</body>

</html>